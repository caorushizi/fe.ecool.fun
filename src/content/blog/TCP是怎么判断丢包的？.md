---
title: TCP是怎么判断丢包的？
pubDatetime: 2022-04-19T16:00:00.000Z
author: caorushizi
tags:
  - 计算机网络
postSlug: 3ab16d0ad961ca43a1ea703c7f1ad3e0
description: >-
  TCP协议传输的特点主要就是面向字节流、传输可靠、面向连接。TCP协议保证数据传输可靠性的方式主要有：*校验和*序列号*确认应答*超时重传*连接管理*流量控制*拥塞控制确认应答与序列号--------
difficulty: 3
questionNumber: 17
source: >-
  https://fe.ecool.fun/topic-answer/919d2e94-71b1-4096-b263-4a1edb0231be?orderBy=updateTime&order=desc&tagId=16
---

TCP 协议传输的特点主要就是面向字节流、传输可靠、面向连接。

TCP 协议保证数据传输可靠性的方式主要有：

- 校验和
- 序列号
- 确认应答
- 超时重传
- 连接管理
- 流量控制
- 拥塞控制

## 确认应答与序列号

序列号：TCP 传输时将每个字节的数据都进行了编号，这就是序列号。

确认应答：TCP 传输的过程中，每次接收方收到数据后，都会对传输方进行确认应答。也就是发送 ACK 报文。这个 ACK 报文当中带有对应的确认序列号，告诉发送方，接收到了哪些数据，下一次的数据从哪里发。

序列号的作用不仅仅是应答的作用，有了序列号能够将接收到的数据根据序列号排序，并且去掉重复序列号的数据。这也是 TCP 传输可靠性的保证之一

## 超时重传

在进行 TCP 传输时，由于确认应答与序列号机制，也就是说发送方发送一部分数据后，都会等待接收方发送的 ACK 报文，并解析 ACK 报文，判断数据是否传输成功。如果发送方发送完数据后，迟迟没有等到接收方的 ACK 报文，这该怎么办呢？而没有收到 ACK 报文的原因可能是什么呢？

发送方没有接收到 ACK 响应的原因：其中一方出现了网络问题。

- 数据发送方：数据发送过程中有由于网络问题全体丢包，接收方根本没有收到数据。
- 数据接收方：数据拿到了。但是发送 ACK 报文的时候由于网络问题，发送失败。

为了解决丢包问题导致的【确认应答、序列号】机制失效，TCP 引入了超时重传机制。简单的理解就是在发送方发送数据后的一段时候内，如果没有接收到接收方的 ACK 响应，那么刚刚发送的数据需要重新发送。对应上面说到的两种原因，如果是数据发方的问题，数据重新发送，数据接收方进行响应 ACK;如果是数据接收方的问题，数据发送过来之后，接收方根据序列号判断是否是重复数据，如果是直接丢弃，然后继续返回 ack 响应。

那么发送方发送完毕后等待的时间是多少呢？如果这个等待的时间过长，那么会影响 TCP 传输的整体效率，如果等待时间过短，又会导致频繁的发送重复的包。如何权衡？

由于 TCP 传输时保证能够在任何环境下都有一个高性能的通信，因此这个最大超时时间（也就是等待的时间）是动态计算的。

## 流量控制

接收端在接收到数据后，对其进行处理。如果发送端的发送速度太快，导致接收端的结束缓冲区很快的填充满了。此时如果发送端仍旧发送数据，那么接下来发送的数据都会丢包，继而导致丢包的一系列连锁反应，超时重传呀什么的。而 TCP 根据接收端对数据的处理能力，决定发送端的发送速度，这个机制就是流量控制。

在 TCP 协议的报头信息当中，有一个 16 位字段的窗口大小。在介绍这个窗口大小时我们知道，窗口大小的内容实际上是接收端接收数据缓冲区的剩余大小。这个数字越大，证明接收端接收缓冲区的剩余空间越大，网络的吞吐量越大。接收端会在确认应答发送 ACK 报文时，将自己的即时窗口大小填入，并跟随 ACK 报文一起发送过去。而发送方根据 ACK 报文里的窗口大小的值的改变进而改变自己的发送速度。如果接收到窗口大小的值为 0，那么发送方将停止发送数据。并定期的向接收端发送窗口探测数据段，让接收端把窗口大小告诉发送端。

## 拥塞控制

TCP 传输的过程中，发送端开始发送数据的时候，如果刚开始就发送大量的数据，那么就可能造成一些问题。网络可能在开始的时候就很拥堵，如果给网络中在扔出大量数据，那么这个拥堵就会加剧。拥堵的加剧就会产生大量的丢包，就对大量的超时重传，严重影响传输。

所以 TCP 引入了慢启动的机制，在开始发送数据时，先发送少量的数据探路。探清当前的网络状态如何，再决定多大的速度进行传输。这时候就引入一个叫做拥塞窗口的概念。发送刚开始定义拥塞窗口为 1，每次收到 ACK 应答，拥塞窗口加 1。在发送数据之前，首先将拥塞窗口与接收端反馈的窗口大小比对，取较小的值作为实际发送的窗口。

拥塞窗口的增长是指数级别的。慢启动的机制只是说明在开始的时候发送的少，发送的慢，但是增长的速度是非常快的。为了控制拥塞窗口的增长，不能使拥塞窗口单纯的加倍，设置一个拥塞窗口的阈值，当拥塞窗口大小超过阈值时，不能再按照指数来增长，而是线性的增长。在慢启动开始的时候，慢启动的阈值等于窗口的最大值，一旦造成网络拥塞，发生超时重传时，慢启动的阈值会为原来的一半（这里的原来指的是发生网络拥塞时拥塞窗口的大小），同时拥塞窗口重置为 1。
