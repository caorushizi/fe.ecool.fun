---
title: 怎么实现图片懒加载？
pubDatetime: 2023-03-25T16:00:00.000Z
author: caorushizi
tags:
  - javascript
postSlug: ba967233f77584ad9512abf71317285b
description: >-
  懒加载是一种网页性能优化的方式，它能极大的提升用户体验。就比如说图片，图片一直是影响网页性能的主要元凶，现在一张图片超过几兆已经是很经常的事了。如果每次进入页面就请求所有的图片资源，那么可能等图片加载
difficulty: 3
questionNumber: 36
source: >-
  https://fe.ecool.fun/topic-answer/d3f21598-edfa-48f4-b2d3-d0c19d754b10?orderBy=updateTime&order=desc&tagId=10
---

懒加载是一种网页性能优化的方式，它能极大的提升用户体验。就比如说图片，图片一直是影响网页性能的主要元凶，现在一张图片超过几兆已经是很经常的事了。如果每次进入页面就请求所有的图片资源，那么可能等图片加载出来用户也早就走了。所以，我们需要懒加载，进入页面的时候，只请求可视区域的图片资源。

总结出来就两个点：

1.  全部加载的话会影响用户体验
2.  浪费用户的流量，有些用户并不想全部看完，全部加载会耗费大量流量。

# 实现方式

## html 实现

最简单的实现方式是给 `img` 标签加上 `loading="lazy"`，比如

```typescript
undefined;
```

该属性的兼容性也还行，大家生产环境可以使用。

![](https://pic.rmb.bdstatic.com/bjh/bc5b155c5016d9979e2da98bcd74730b.png)

预览

## js 实现原理

我们通过 js 监听页面的滚动也能实现。

使用 js 实现的原理主要是判断当前图片是否到了可视区域：

- 拿到所有的图片 dom 。
- 遍历每个图片判断当前图片是否到了可视区范围内。
- 如果到了就设置图片的 src 属性。
- 绑定 window 的 scroll 事件，对其进行事件监听。

在页面初始化的时候，<img>图片的 src 实际上是放在 data-src 属性上的，当元素处于可视范围内的时候，就把 data-src 赋值给 src 属性，完成图片加载。

```typescript
undefined;
```

<div>使用背景图来实现，原理也是一样的，把图片链接存放在 \`data-src\` 中，在可视范围时，就把data-src赋值给 \`background-image\` 属性，完成图片加载。

```typescript
undefined;
```

下面展示一个 demo：

```typescript
undefined;
```

先获取所有图片的 dom，通过 `window.innerHeight || document.documentElement.clientHeight|| document.body.clientHeight` 获取可视区高度，再使用 `element.getBoundingClientRect()` API 直接得到元素相对浏览的 top 值， 遍历每个图片判断当前图片是否到了可视区范围内。代码如下：

```typescript
undefined;
```

最后给 window 绑定 onscroll 事件

```typescript
undefined;
```

主要就完成了一个图片懒加载的操作了。但是这样存在较大的性能问题，因为 scroll 事件会在很短的时间内触发很多次，严重影响页面性能，为了提高网页性能，我们需要一个节流函数来控制函数的多次触发，在一段时间内（如 200ms）只执行一次回调。

下面实现一个节流函数

```typescript
undefined;
```

然后修改一下 srcoll 事件

```typescript
undefined;
```

## 拓展： IntersectionObserver

通过上面例子的实现，我们要实现懒加载都需要去监听 scroll 事件，尽管我们可以通过函数节流的方式来阻止高频率的执行函数，但是我们还是需要去计算 scrollTop，offsetHeight 等属性，有没有简单的不需要计算这些属性的方式呢，答案就是 `IntersectionObserver`。

`IntersectionObserver` 是一个比较新的 API，可以自动"观察"元素是否可见，Chrome 51+ 已经支持。由于可见（visible）的本质是，目标元素与视口产生一个交叉区，所以这个 API 叫做"交叉观察器"。我们来看一下它的用法：

```typescript
undefined;
```

IntersectionObserver 是浏览器原生提供的构造函数，接受两个参数：callback 是可见性变化时的回调函数，option 是配置对象（该参数可选）。

目标元素的可见性变化时，就会调用观察器的回调函数 callback。callback 一般会触发两次。一次是目标元素刚刚进入视口（开始可见），另一次是完全离开视口（开始不可见）。

下面我们用 IntersectionObserver 实现图片懒加载

```typescript
undefined;
```
